<!DOCTYPE html>
<html>
<head>
    <title>Home Controller</title>
    <link rel="stylesheet" href="{{ url_for ('static', filename='style.css')}}">
    <script>
        function measure() {
            // // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
            // const measureBtn = event.target;
            // measureBtn.disabled = true;
            // measureBtn.textContent = 'ì¸¡ì • ì¤‘...';
            // document.getElementById("result").innerHTML = "ğŸ”„ ì¸¡ì • ì¤‘...";           
            fetch("/measure", {
                    method: "POST"
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        var today = new Date();
                        var year = today.getFullYear();
                        var month = ('0' + (today.getMonth() + 1)).slice(-2);
                        var day =  ('0' + today.getDate()).slice(-2);
                        var hours = ('0' + today.getHours()).slice(-2);
                        var mins = ('0' + today.getMinutes()).slice(-2);
                        var seconds = ('0' + today.getSeconds()).slice(-2);
                        var dateTimeString = year + '-' + month + '-' + day + ' ' + hours + ':' + mins + ':' + seconds;
                        document.getElementById("measure-result").innerHTML = `
                        ğŸŒ¡ ì˜¨ë„: ${data.temperature}â„ƒ <br>
                        ğŸ’§ ìŠµë„: ${data.humidity}% <br>
                        ğŸ“… ì¸¡ì • ì‹œê°„: ${dateTimeString}
                        `;
                    } else {
                        document.getElementById("measure-result").innerHTML = `
                        âŒ ì¸¡ì • ì‹¤íŒ¨: ${data.error}
                        `;
                    }
                })
                .catch(err => {
                    document.getElementById("measure-result").innerHTML =
                        "âŒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err;
                })
                .finally(() => {
                    // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                    measureBtn.disabled = false;
                    measureBtn.textContent = 'ğŸ“¥ ì¸¡ì •';
                });
        }

        // LED ì œì–´ë¥¼ AJAXë¡œ ë³€ê²½ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€)
        function toggleLED() {
            const ledBtn = event.target;
            ledBtn.disabled = true;
            
            fetch("/ledControl", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        ledBtn.textContent = data.button_text || 'LED ì œì–´';
                        document.getElementById("led-status").textContent = data.led_state ? 'ON' : 'OFF';
                    } else {
                        alert('LED ì œì–´ ì‹¤íŒ¨');
                    }
                })
                .catch(err => {
                    console.error('LED ì œì–´ ì˜¤ë¥˜:', err);
                    // ì˜¤ë¥˜ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ í´ë°±
                    window.location.reload();
                })
                .finally(() => {
                    ledBtn.disabled = false;
                });
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
            });
            const day = String(now.getDate());
            const month = now.toLocaleDateString('en-US', {month: 'long'});
            const formattedDate = `${day} ${month}`;
            document.getElementById("time-text").textContent = timeString;
            document.getElementById("current-date").textContent = `${formattedDate}`;
        }

        // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        setInterval(updateTime, 1000);
        updateTime();  // ì²˜ìŒ í•œ ë²ˆ ì¦‰ì‹œ ì‹¤í–‰
    </script>
</head>
<body>
    <div class="container">
        <div class="title-container">
            <h1>í™˜ê²½ ê°ì‹œ ì‹œìŠ¤í…œ</h1>
            <!-- <div class="date-time"> -->
            <div class="current-time">â°<span id="time-text"></span></div>
            <!-- </div>? -->
        </div>
        <!-- Flexë¡œ ì •ë ¬í•  ë¶€ëª¨ -->
        <div class="info-wrapper">
            <div class="info-card">
                <div class="info-left">
                    <div class="user">
                        <h2>Welcome<br> {{ user_nick }} !</h2>
                        <br>
                    </div>
                    <span id="current-date"></span>
                <!-- ì˜¨ìŠµë„ ì •ë³´ -->
                    <!-- <h3>ğŸ“Š ìµœê·¼ ì˜¨ìŠµë„ ì •ë³´</h3> -->
                    <!-- ğŸ“‹ ê°€ì¥ ìµœê·¼ ì •ë³´ -->
                    <div id="measure-result">
                        <div class="result-wrapper">
                            <div class="result-box" id="result">ğŸŒ¡ï¸ {{ temp|round|int }} â„ƒ </div>
                            <div class="result-box" id="result">ğŸ’§ {{ humid|round|int }} %</div>
                            <div class="result-box" id="result"> {{ weather_info }}</div>
                        </div>
                        <!-- <button onclick="measure()"> ì‹¤ì‹œê°„ ì¸¡ì •</button> -->
                        <!-- <p id="mes_btn">â€» ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¸¡ì •í•´ë³´ì„¸ìš”!</p> -->
                    </div>
                </div>
                <div class="info-right">
                    <div style="width: 100px; height: 100px; background: white; border-radius: 50%; 
                        display: flex; justify-content: center; align-items: center; font-size: 48px;">
                        ğŸ‘¨â€ğŸ’»
                    </div>
                    <form action="/logout" method="get">
                        <button id="logout" type="submit">LOGOUT</button>
                    </form>
                </div>
            </div>
        </div>
        <!-- ğŸ’¡ LED ì¹´ë“œ -->
        <div class="bottom-wrapper">
            <div class="led-container card-box">
                <div class="led-bottom">
                    <h3>LED</h3>
                    <div class="led-status">
                        ğŸ’¡ í˜„ì¬ ìƒíƒœ: <span id="led-status">{{ 'ON' if led_state else 'OFF' }} </span>
                        <button class="led-button" onclick="toggleLED()">{{ 'OFF' if led_state else 'ON' }}</button>
                    </div>
                    <!-- AJAX ë°©ì‹ìœ¼ë¡œ ë³€ê²½ -->
                </div>
            </div>
            <div class="temp-container card-box">
                <h3>Temperature</h3>
                <h1>ğŸŒ¡ï¸ {{ temp|round|int }} â„ƒ</h1>
            </div>
            <div class="humid-container card-box">
                <h3>Humidity</h3>
                <h1>ğŸ’§ {{ humid|round|int }} %</h1>
            </div>
        </div>
    </div>
    <!-- ê¸°ì¡´ form ë°©ì‹ë„ ë‚¨ê²¨ë‘  (ë°±ì—…ìš©) -->
    <!-- 
    <form action="/ledControl" method="post">
        <button type="submit">{{ 'OFF' if led_state else 'ON' }}</button>
    </form>
    -->
</body>
</html>
